---
phase: 03-terra-integration
plan: 02
type: execute
wave: 1
depends_on: ["03-01"]
files_modified:
  - pipes/WDL/tasks/tasks_metagenomics.wdl
  - pipes/WDL/workflows/genomad_single.wdl
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Counts (total_viruses, total_plasmids) are truly undefined (null) when zero, not 0"
    - "Top virus score (top_virus_score) is truly undefined (null) when no viruses found, not 0.0"
    - "Counts are correctly populated with positive integers when genomad finds hits"
    - "String outputs (top_virus_name, top_virus_taxonomy) remain empty string when no viruses"
    - "All modified WDL files pass miniwdl check validation without UnnecessaryQuantifier warnings for genomad outputs"
    - "miniwdl runtime execution produces null for optional outputs when no hits found"
  artifacts:
    - path: "pipes/WDL/tasks/tasks_metagenomics.wdl"
      provides: "report_genomad_summary task with Array[File] outputs for optional primitive extraction at workflow level"
      contains: "Array[File]"
    - path: "pipes/WDL/workflows/genomad_single.wdl"
      provides: "Workflow-level conditional extraction of optional primitives using if blocks"
      contains: "if (length("
  key_links:
    - from: "pipes/WDL/tasks/tasks_metagenomics.wdl"
      to: "pipes/WDL/workflows/genomad_single.wdl"
      via: "Task outputs Array[File] glob results consumed by workflow if-blocks for conditional extraction"
      pattern: "report_genomad_summary\\.total_viruses_file"
---

<objective>
Close verification gaps 1 and 2: Optional Int?/Float? outputs return 0 instead of truly undefined (null) when zero hits found.

Purpose: The user decision (CONTEXT.md) explicitly requires "Leave undefined (optional Int?) to distinguish 'not run' from 'ran and found zero'." The current implementation returns 0, which Terra displays as "0" in data tables instead of blank cells. This gap closure implements a verified WDL 1.0 pattern that achieves true runtime null for optional primitives.

Output: Modified task and workflow that produce null (not 0) for counts and scores when genomad finds zero hits.

**Verified Solution (tested with miniwdl runtime):**
- Task level: Change Int?/Float? outputs to Array[File] (glob results of conditionally-created files)
- Workflow level: Use conditional `if` blocks to extract values from Array[File] only when files exist
- Result: Variables declared inside `if` blocks are Optional at workflow output level, producing true null when condition is false

This pattern was verified with `pixi run miniwdl run` producing `"total_plasmids": null` (not 0) in output JSON.
</objective>

<execution_context>
@/home/unix/carze/.claude/get-shit-done/workflows/execute-plan.md
@/home/unix/carze/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-terra-integration/03-01-SUMMARY.md
@.planning/phases/03-terra-integration/03-VERIFICATION.md
@.planning/phases/03-terra-integration/03-CONTEXT.md
@pipes/WDL/tasks/tasks_metagenomics.wdl (lines 1068-1151 for report_genomad_summary task)
@pipes/WDL/workflows/genomad_single.wdl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor report_genomad_summary outputs and genomad_single workflow for true optional primitives</name>
  <files>pipes/WDL/tasks/tasks_metagenomics.wdl, pipes/WDL/workflows/genomad_single.wdl</files>
  <action>
This task modifies both files together because the changes are tightly coupled (task output type changes require workflow changes).

**Part A: Modify report_genomad_summary task output block (tasks_metagenomics.wdl)**

The command block is CORRECT and unchanged. Only the output block needs modification.

Replace the current output block (lines 1133-1139):
```wdl
  output {
    Int?   total_viruses = if length(glob("TOTAL_VIRUSES")) > 0 then read_int(glob("TOTAL_VIRUSES")[0]) else 0
    Int?   total_plasmids = if length(glob("TOTAL_PLASMIDS")) > 0 then read_int(glob("TOTAL_PLASMIDS")[0]) else 0
    String top_virus_name = read_string("TOP_VIRUS_NAME")
    Float? top_virus_score = if length(glob("TOP_VIRUS_SCORE")) > 0 then read_float(glob("TOP_VIRUS_SCORE")[0]) else 0.0
    String top_virus_taxonomy = read_string("TOP_VIRUS_TAXONOMY")
  }
```

With this new output block:
```wdl
  output {
    Array[File] total_viruses_file    = glob("TOTAL_VIRUSES")
    Array[File] total_plasmids_file   = glob("TOTAL_PLASMIDS")
    String      top_virus_name        = read_string("TOP_VIRUS_NAME")
    Array[File] top_virus_score_file  = glob("TOP_VIRUS_SCORE")
    String      top_virus_taxonomy    = read_string("TOP_VIRUS_TAXONOMY")
  }
```

**Why this works:** The glob() returns an empty array when the file was not created (count was 0 or no viruses). The Array[File] is always valid (empty or single-element). The workflow level then conditionally extracts the value.

**Part B: Modify genomad_single.wdl workflow to extract optional values**

Replace the current workflow body after the two `call` statements (lines 44-67) with conditional extraction blocks and updated outputs.

Between the `call report_genomad_summary` block and the `output` block, add three conditional extraction blocks:

```wdl
    # Extract optional counts/scores — truly undefined when zero
    if (length(report_genomad_summary.total_viruses_file) > 0) {
        Int extracted_total_viruses = read_int(report_genomad_summary.total_viruses_file[0])
    }
    if (length(report_genomad_summary.total_plasmids_file) > 0) {
        Int extracted_total_plasmids = read_int(report_genomad_summary.total_plasmids_file[0])
    }
    if (length(report_genomad_summary.top_virus_score_file) > 0) {
        Float extracted_top_virus_score = read_float(report_genomad_summary.top_virus_score_file[0])
    }
```

Update the output block to reference the conditionally-extracted variables:
```wdl
    output {
        # Genomad result files (always present, may be empty/header-only)
        File   virus_summary_tsv    = genomad_end_to_end.virus_summary
        File   plasmid_summary_tsv  = genomad_end_to_end.plasmid_summary
        File   virus_fasta          = genomad_end_to_end.virus_fasta
        File   plasmid_fasta        = genomad_end_to_end.plasmid_fasta

        # Summary statistics for Terra data tables
        Int?   total_viruses         = extracted_total_viruses
        Int?   total_plasmids        = extracted_total_plasmids
        String top_virus_name        = report_genomad_summary.top_virus_name
        Float? top_virus_score       = extracted_top_virus_score
        String top_virus_taxonomy    = report_genomad_summary.top_virus_taxonomy

        # Runtime metadata
        Int    genomad_max_ram_gb    = genomad_end_to_end.max_ram_gb
        String viral_classify_version = genomad_end_to_end.viralngs_version
    }
```

**Why this works:** Variables declared inside `if` blocks in WDL 1.0 are Optional outside the block. When the condition is false (empty array = file not created = zero hits), the variable is truly undefined (null), not 0. This was verified with miniwdl runtime producing `"total_plasmids": null` in output JSON.

**Do NOT change:**
- The command block (bash parsing logic is correct)
- The runtime block
- The meta/parameter_meta blocks
- The genomad_end_to_end task
- The genomad_multi.wdl workflow (does not call report_genomad_summary)
  </action>
  <verify>
1. Run `pixi run miniwdl check pipes/WDL/tasks/tasks_metagenomics.wdl` — must pass with no errors
2. Run `pixi run miniwdl check pipes/WDL/workflows/genomad_single.wdl` — must pass with no errors
3. Run `pixi run miniwdl check pipes/WDL/workflows/genomad_multi.wdl` — must pass with no errors (unchanged but verify no breakage)
4. Verify the report_genomad_summary task output block contains `Array[File]` (not `Int?` or `Float?` with `else 0`)
5. Verify genomad_single.wdl contains three `if (length(` conditional blocks for extraction
6. Verify genomad_single.wdl output block has `Int? total_viruses = extracted_total_viruses` (not `report_genomad_summary.total_viruses`)
7. Verify NO `UnnecessaryQuantifier` warnings from miniwdl for the genomad outputs (because Array[File] is always valid)
8. Grep for "else 0" in report_genomad_summary task — must return zero matches (the 0-fallback pattern is removed)
  </verify>
  <done>
report_genomad_summary task outputs Array[File] for optional values. genomad_single.wdl conditionally extracts Int?/Float? values using if-blocks, producing true null (not 0) when genomad finds zero hits. All three WDL files pass miniwdl check validation. No UnnecessaryQuantifier warnings for genomad outputs.
  </done>
</task>

</tasks>

<verification>
1. `pixi run miniwdl check pipes/WDL/tasks/tasks_metagenomics.wdl` passes
2. `pixi run miniwdl check pipes/WDL/workflows/genomad_single.wdl` passes
3. `pixi run miniwdl check pipes/WDL/workflows/genomad_multi.wdl` passes
4. report_genomad_summary output block uses `Array[File]` pattern (no `else 0` fallback)
5. genomad_single.wdl has conditional `if (length(...))` extraction blocks
6. genomad_single.wdl outputs reference conditionally-extracted variables (not direct task outputs)
7. No `UnnecessaryQuantifier` warnings from miniwdl for genomad optional outputs
</verification>

<success_criteria>
- Optional Int?/Float? workflow outputs produce true null (not 0) when genomad finds zero hits
- Positive counts/scores are correctly populated when genomad finds hits
- String outputs remain empty string when no viruses (unchanged behavior)
- All three WDL files pass miniwdl check with zero errors
- Pattern is pure WDL 1.0 (no WDL 1.1 features used)
</success_criteria>

<output>
After completion, create `.planning/phases/03-terra-integration/03-02-SUMMARY.md`
</output>
